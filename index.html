<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KJ Tracker</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
        }
        .container { max-width: 28rem; margin: 0 auto; padding: 1rem; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .tabs { display: flex; gap: 0.5rem; padding: 0.5rem; }
        .tab { flex: 1; padding: 0.75rem; border-radius: 1rem; border: none; font-weight: 500; cursor: pointer; transition: all 0.3s; background: transparent; color: #6b7280; }
        .tab:hover { background: #f3f4f6; }
        .tab.active { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .remaining-display { text-align: center; }
        .remaining-label { color: #6b7280; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .remaining-value { font-size: 3rem; font-weight: 700; }
        .remaining-value.positive { color: #16a34a; }
        .remaining-value.negative { color: #dc2626; }
        .remaining-unit { color: #9ca3af; font-size: 0.875rem; margin-top: 0.25rem; }
        .progress-bar { background: #f3f4f6; border-radius: 9999px; height: 0.75rem; overflow: hidden; margin-top: 1rem; }
        .progress-fill { height: 100%; transition: width 0.3s; }
        .progress-fill.good { background: #16a34a; }
        .progress-fill.over { background: #dc2626; }
        .progress-text { text-align: center; color: #9ca3af; font-size: 0.75rem; margin-top: 0.5rem; }
        h3 { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .meal-btn { padding: 0.75rem 1rem; border-radius: 0.75rem; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s; background: #f3f4f6; color: #374151; }
        .meal-btn:hover { background: #e5e7eb; }
        .meal-btn.active { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; }
        input:focus { outline: none; border-color: #4f46e5; }
        .btn-primary { width: 100%; padding: 0.75rem; background: #4f46e5; color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .btn-primary:hover { background: #4338ca; }
        .meal-item, .weight-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f9fafb; border-radius: 0.75rem; margin-bottom: 0.75rem; }
        .meal-info { display: flex; align-items: center; gap: 0.75rem; }
        .meal-emoji { font-size: 1.5rem; }
        .meal-name { font-weight: 500; color: #1f2937; }
        .meal-time { font-size: 0.875rem; color: #6b7280; }
        .meal-kj { font-weight: 700; color: #4f46e5; margin-right: 0.75rem; }
        .btn-delete { background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.25rem; }
        .btn-delete:hover { color: #dc2626; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .stat-box { text-align: center; }
        .stat-label { color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.875rem; font-weight: 700; color: #4f46e5; }
        .stat-value.loss { color: #16a34a; }
        .stat-unit { font-size: 1.125rem; color: #9ca3af; margin-left: 0.25rem; }
        .chart-container { height: 200px; margin-top: 1rem; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Plus = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        function WeightChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || data.length < 2) return;

                const ctx = canvasRef.current.getContext('2d');
                
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.displayDate),
                        datasets: [{
                            label: 'Weight (kg)',
                            data: data.map(d => d.weight),
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            pointRadius: 5,
                            pointBackgroundColor: '#4f46e5'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                grid: { color: '#e5e7eb' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            if (data.length < 2) return null;

            return (
                <div className="card">
                    <h3>Weight Progress</h3>
                    <div className="chart-container">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        function KilojouleTracker() {
            const DAILY_LIMIT = 6500;
            const [meals, setMeals] = useState([]);
            const [mealType, setMealType] = useState('Breakfast');
            const [kilojoules, setKilojoules] = useState('');
            const [weightEntries, setWeightEntries] = useState([]);
            const [newWeight, setNewWeight] = useState('');
            const [showWeightSection, setShowWeightSection] = useState(false);

            useEffect(() => {
                loadMeals();
                loadWeightEntries();
            }, []);

            const loadMeals = () => {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const stored = localStorage.getItem(`meals:${today}`);
                    if (stored) {
                        setMeals(JSON.parse(stored));
                    }
                } catch (error) {
                    console.log('No meals found');
                }
            };

            const saveMeals = (updatedMeals) => {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    localStorage.setItem(`meals:${today}`, JSON.stringify(updatedMeals));
                } catch (error) {
                    console.error('Error saving meals:', error);
                }
            };

            const loadWeightEntries = () => {
                try {
                    const stored = localStorage.getItem('weight-entries');
                    if (stored) {
                        setWeightEntries(JSON.parse(stored));
                    }
                } catch (error) {
                    console.log('No weight entries found');
                }
            };

            const saveWeightEntries = (entries) => {
                try {
                    localStorage.setItem('weight-entries', JSON.stringify(entries));
                } catch (error) {
                    console.error('Error saving weight entries:', error);
                }
            };

            const addWeightEntry = () => {
                if (!newWeight || isNaN(newWeight) || Number(newWeight) <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                const entry = {
                    id: Date.now(),
                    weight: Number(newWeight),
                    date: new Date().toISOString().split('T')[0],
                    displayDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                };

                const updatedEntries = [...weightEntries, entry].sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );
                
                setWeightEntries(updatedEntries);
                saveWeightEntries(updatedEntries);
                setNewWeight('');
            };

            const deleteWeightEntry = (id) => {
                const updatedEntries = weightEntries.filter(entry => entry.id !== id);
                setWeightEntries(updatedEntries);
                saveWeightEntries(updatedEntries);
            };

            const totalKJ = meals.reduce((sum, meal) => sum + meal.kj, 0);
            const remaining = DAILY_LIMIT - totalKJ;

            const addMeal = () => {
                if (!kilojoules || isNaN(kilojoules) || Number(kilojoules) <= 0) {
                    alert('Please enter a valid kilojoule amount');
                    return;
                }

                const newMeal = {
                    id: Date.now(),
                    type: mealType,
                    kj: Number(kilojoules),
                    time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };

                const updatedMeals = [...meals, newMeal];
                setMeals(updatedMeals);
                saveMeals(updatedMeals);
                setKilojoules('');
            };

            const deleteMeal = (id) => {
                const updatedMeals = meals.filter(meal => meal.id !== id);
                setMeals(updatedMeals);
                saveMeals(updatedMeals);
            };

            const getMealEmoji = (type) => {
                const emojis = {
                    'Breakfast': 'üç≥',
                    'Lunch': 'üç±',
                    'Dinner': 'üçΩÔ∏è',
                    'Dessert': 'üç∞'
                };
                return emojis[type] || 'üç¥';
            };

            const weightLoss = weightEntries.length >= 2 
                ? weightEntries[0].weight - weightEntries[weightEntries.length - 1].weight 
                : 0;

            return (
                <div className="container">
                    <div className="card tabs">
                        <button
                            onClick={() => setShowWeightSection(false)}
                            className={`tab ${!showWeightSection ? 'active' : ''}`}
                        >
                            üçΩÔ∏è Today
                        </button>
                        <button
                            onClick={() => setShowWeightSection(true)}
                            className={`tab ${showWeightSection ? 'active' : ''}`}
                        >
                            üìä Weight
                        </button>
                    </div>

                    {!showWeightSection ? (
                        <>
                            <div className="card remaining-display">
                                <div className="remaining-label">Remaining Today</div>
                                <div className={`remaining-value ${remaining >= 0 ? 'positive' : 'negative'}`}>
                                    {remaining.toLocaleString()}
                                </div>
                                <div className="remaining-unit">kJ</div>
                                <div className="progress-bar">
                                    <div 
                                        className={`progress-fill ${totalKJ > DAILY_LIMIT ? 'over' : 'good'}`}
                                        style={{ width: `${Math.min((totalKJ / DAILY_LIMIT) * 100, 100)}%` }}
                                    />
                                </div>
                                <div className="progress-text">
                                    {totalKJ.toLocaleString()} / {DAILY_LIMIT.toLocaleString()} kJ
                                </div>
                            </div>

                            <div className="card">
                                <h3>Log Meal</h3>
                                <label>Meal Type</label>
                                <div className="button-grid">
                                    {['Breakfast', 'Lunch', 'Dinner', 'Dessert'].map(type => (
                                        <button
                                            key={type}
                                            onClick={() => setMealType(type)}
                                            className={`meal-btn ${mealType === type ? 'active' : ''}`}
                                        >
                                            {getMealEmoji(type)} {type}
                                        </button>
                                    ))}
                                </div>
                                <label>Kilojoules</label>
                                <input
                                    type="number"
                                    value={kilojoules}
                                    onChange={(e) => setKilojoules(e.target.value)}
                                    placeholder="Enter kJ"
                                />
                                <button onClick={addMeal} className="btn-primary">
                                    <Plus /> Add Meal
                                </button>
                            </div>

                            {meals.length > 0 && (
                                <div className="card">
                                    <h3>Today's Meals</h3>
                                    {meals.map(meal => (
                                        <div key={meal.id} className="meal-item">
                                            <div className="meal-info">
                                                <span className="meal-emoji">{getMealEmoji(meal.type)}</span>
                                                <div>
                                                    <div className="meal-name">{meal.type}</div>
                                                    <div className="meal-time">{meal.time}</div>
                                                </div>
                                            </div>
                                            <div style={{display: 'flex', alignItems: 'center'}}>
                                                <span className="meal-kj">{meal.kj} kJ</span>
                                                <button onClick={() => deleteMeal(meal.id)} className="btn-delete">
                                                    <Trash2 />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    ) : (
                        <>
                            {weightEntries.length > 0 && (
                                <div className="card">
                                    <div className="stats-grid">
                                        <div className="stat-box">
                                            <div className="stat-label">Current Weight</div>
                                            <div className="stat-value">
                                                {weightEntries[weightEntries.length - 1].weight}
                                                <span className="stat-unit">kg</span>
                                            </div>
                                        </div>
                                        <div className="stat-box">
                                            <div className="stat-label">Total Loss</div>
                                            <div className={`stat-value ${weightLoss > 0 ? 'loss' : ''}`}>
                                                {weightLoss > 0 ? '-' : ''}{Math.abs(weightLoss).toFixed(1)}
                                                <span className="stat-unit">kg</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <WeightChart data={weightEntries} />

                            <div className="card">
                                <h3>Log Weight</h3>
                                <label>Weight (kg)</label>
                                <input
                                    type="number"
                                    step="0.1"
                                    value={newWeight}
                                    onChange={(e) => setNewWeight(e.target.value)}
                                    placeholder="Enter weight in kg"
                                />
                                <button onClick={addWeightEntry} className="btn-primary">
                                    üìä Add Weight
                                </button>
                            </div>

                            {weightEntries.length > 0 && (
                                <div className="card">
                                    <h3>Weight History</h3>
                                    {[...weightEntries].reverse().map(entry => (
                                        <div key={entry.id} className="weight-item">
                                            <div>
                                                <div className="meal-name">{entry.weight} kg</div>
                                                <div className="meal-time">{entry.date}</div>
                                            </div>
                                            <button onClick={() => deleteWeightEntry(entry.id)} className="btn-delete">
                                                <Trash2 />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<KilojouleTracker />, document.getElementById('root'));
    </script>
</body>
</html>