<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="KJ Tracker">
    <title>KJ Tracker</title>
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" href="./icon-192.png">
    <meta name="theme-color" content="#6987fe">
    <link rel="manifest" href="./manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #d8e7f7 0%, #d3e2f4 50%, #ceddee 100%);
            min-height: 100vh;
            font-weight: 500;
            color: #4b5563;
        }
        .container { max-width: 28rem; margin: 0 auto; padding: 1rem; }
        .card { 
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border-radius: 1.5rem; 
            box-shadow: 9px 9px 16px rgba(163, 177, 198, 0.6), -9px -9px 16px rgba(255, 255, 255, 0.5);
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .tabs { display: flex; gap: 0.5rem; padding: 0.5rem; }
        .tab { 
            flex: 1; 
            padding: 0.75rem; 
            border-radius: 1rem; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            color: #6b7280;
            box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.6), -5px -5px 10px rgba(255, 255, 255, 0.5);
        }
        .tab:active { 
            box-shadow: inset 3px 3px 7px rgba(163, 177, 198, 0.6), inset -3px -3px 7px rgba(255, 255, 255, 0.5);
        }
        .tab.active { 
            background: linear-gradient(145deg, #dae2eb, #cfd9e3);
            color: #4f46e5; 
            box-shadow: inset 3px 3px 7px rgba(163, 177, 198, 0.6), inset -3px -3px 7px rgba(255, 255, 255, 0.5);
        }
        .remaining-display { text-align: center; position: relative; }
        .remaining-label { color: #6b7280; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .unit-toggle { 
            background: linear-gradient(145deg, #d8e7f7, #d3e2f4);
            border: none;
            color: #6b7280;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            box-shadow: 2px 2px 4px rgba(163, 177, 198, 0.4), -2px -2px 4px rgba(255, 255, 255, 0.6);
        }
        .unit-toggle:active {
            box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.4), inset -2px -2px 4px rgba(255, 255, 255, 0.6);
        }
        .remaining-value { font-size: 3rem; font-weight: 700; }
        .remaining-value.positive { 
            background: linear-gradient(135deg, #22c55e, #16a34a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .remaining-value.negative { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .remaining-unit { color: #9ca3af; font-size: 0.875rem; margin-top: 0.25rem; }
        .progress-bar { 
            background: linear-gradient(145deg, #d5dfe8, #dfe7ef);
            border-radius: 9999px; 
            height: 0.75rem; 
            overflow: hidden; 
            margin-top: 1rem;
            box-shadow: inset 2px 2px 5px rgba(163, 177, 198, 0.6), inset -2px -2px 5px rgba(255, 255, 255, 0.5);
        }
        .progress-fill { height: 100%; transition: width 0.3s; border-radius: 9999px; }
        .progress-fill.good { background: linear-gradient(90deg, #22c55e, #16a34a, #15803d); }
        .progress-fill.over { background: linear-gradient(90deg, #f87171, #ef4444, #dc2626); }
        .progress-text { text-align: center; color: #9ca3af; font-size: 0.75rem; margin-top: 0.5rem; }
        h3 { 
            font-size: 1.125rem; 
            font-weight: 700; 
            color: #4b5563;
            margin-bottom: 1rem; 
        }
        label { display: block; font-size: 0.875rem; font-weight: 600; color: #4b5563; margin-bottom: 0.5rem; }
        .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .meal-btn { 
            padding: 0.75rem 1rem; 
            border-radius: 0.75rem; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            color: #374151;
            box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.6), -5px -5px 10px rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            font-family: 'Poppins', sans-serif;
        }
        .meal-btn:active { 
            box-shadow: inset 3px 3px 7px rgba(163, 177, 198, 0.6), inset -3px -3px 7px rgba(255, 255, 255, 0.5);
        }
        .meal-btn.active { 
            background: linear-gradient(145deg, #dae2eb, #cfd9e3);
            color: #4f46e5;
            box-shadow: inset 3px 3px 7px rgba(163, 177, 198, 0.6), inset -3px -3px 7px rgba(255, 255, 255, 0.5);
        }
        input { 
            width: 100%; 
            padding: 0.75rem 1rem; 
            border: none;
            border-radius: 0.75rem; 
            font-size: 1rem;
            background: linear-gradient(145deg, #d5dfe8, #dfe7ef);
            box-shadow: inset 3px 3px 7px rgba(163, 177, 198, 0.6), inset -3px -3px 7px rgba(255, 255, 255, 0.5);
            color: #374151;
        }
        input:focus { outline: none; box-shadow: inset 4px 4px 8px rgba(163, 177, 198, 0.6), inset -4px -4px 8px rgba(255, 255, 255, 0.5); }
        input::placeholder { color: #9ca3af; }
        .btn-primary { 
            width: 100%; 
            padding: 0.75rem; 
            background: linear-gradient(135deg, #849efe, #6987fe);
            color: white; 
            border: none; 
            border-radius: 0.75rem; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            margin-top: 1rem;
            box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.6), -5px -5px 10px rgba(255, 255, 255, 0.5);
        }
        .btn-primary:active { 
            box-shadow: inset 3px 3px 7px rgba(105, 135, 254, 0.8), inset -3px -3px 7px rgba(132, 158, 254, 0.8);
        }
        .meal-item, .weight-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 1rem; 
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border-radius: 0.75rem; 
            margin-bottom: 0.75rem;
            box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.6), -5px -5px 10px rgba(255, 255, 255, 0.5);
        }
        .meal-info { display: flex; align-items: center; gap: 0.75rem; }
        .meal-emoji { font-size: 1.5rem; }
        .meal-name { font-weight: 600; color: #4b5563; }
        .meal-time { font-size: 0.875rem; color: #6b7280; }
        .meal-kj { 
            font-weight: 700; 
            color: #80e7b8;
            margin-right: 0.75rem; 
        }
        .btn-delete { 
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border: none; 
            color: #ef4444; 
            cursor: pointer; 
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 3px 3px 6px rgba(163, 177, 198, 0.6), -3px -3px 6px rgba(255, 255, 255, 0.5);
        }
        .btn-delete:active { 
            box-shadow: inset 2px 2px 5px rgba(163, 177, 198, 0.6), inset -2px -2px 5px rgba(255, 255, 255, 0.5);
        }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .stat-box { 
            text-align: center;
            padding: 1rem;
            border-radius: 1rem;
            background: linear-gradient(145deg, #d5dfe8, #dfe7ef);
            box-shadow: inset 3px 3px 7px rgba(163, 177, 198, 0.4), inset -3px -3px 7px rgba(255, 255, 255, 0.4);
        }
        .stat-label { color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .stat-value { 
            font-size: 1.875rem; 
            font-weight: 700; 
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-value.loss { 
            background: linear-gradient(135deg, #22c55e, #16a34a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-unit { font-size: 1.125rem; color: #9ca3af; margin-left: 0.25rem; }
        .chart-container { height: 200px; margin-top: 1rem; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal-content {
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border-radius: 1.5rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4b5563;
        }
        .modal-close {
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border: none;
            color: #6b7280;
            font-size: 1.5rem;
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 6px rgba(163, 177, 198, 0.6), -3px -3px 6px rgba(255, 255, 255, 0.5);
        }
        .modal-close:active {
            box-shadow: inset 2px 2px 5px rgba(163, 177, 198, 0.6), inset -2px -2px 5px rgba(255, 255, 255, 0.5);
        }
        .calc-result {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(145deg, #d8e7f7, #d3e2f4);
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.4), inset -2px -2px 4px rgba(255, 255, 255, 0.4);
        }
        .calc-result-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .calc-result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6987fe;
        }
        .header-with-icon {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .calc-icon-btn {
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border: none;
            color: #6987fe;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 3px 3px 6px rgba(163, 177, 198, 0.6), -3px -3px 6px rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calc-icon-btn:active {
            box-shadow: inset 2px 2px 5px rgba(163, 177, 198, 0.6), inset -2px -2px 5px rgba(255, 255, 255, 0.5);
        }
        .calculator-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(145deg, #d8e7f7, #d3e2f4);
            border-radius: 0.75rem;
            box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.4), inset -2px -2px 4px rgba(255, 255, 255, 0.4);
        }
        .calculator-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .search-result-item {
            padding: 0.75rem;
            background: linear-gradient(145deg, #f2f8ff, #edf5ff);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            box-shadow: 2px 2px 4px rgba(163, 177, 198, 0.3), -2px -2px 4px rgba(255, 255, 255, 0.3);
        }
        .search-result-item:active {
            box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.3), inset -2px -2px 4px rgba(255, 255, 255, 0.3);
        }
        .search-result-name {
            font-weight: 600;
            color: #4b5563;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        .search-result-brand {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .search-result-kj {
            font-size: 0.75rem;
            color: #6987fe;
            font-weight: 600;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(145deg, #d8e7f7, #d3e2f4);
            border-radius: 0.75rem;
            box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.4), inset -2px -2px 4px rgba(255, 255, 255, 0.4);
        }
        .checkbox-container input[type="checkbox"] {
            width: auto;
            cursor: pointer;
            margin: 0;
            box-shadow: none;
        }
        .checkbox-label {
            flex: 1;
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Plus = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        function WeightChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || data.length < 2) return;

                const ctx = canvasRef.current.getContext('2d');
                
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.displayDate),
                        datasets: [{
                            label: 'Weight (kg)',
                            data: data.map(d => d.weight),
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            pointRadius: 5,
                            pointBackgroundColor: '#4f46e5'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                grid: { color: '#e5e7eb' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            if (data.length < 2) return null;

            return (
                <div className="card">
                    <h3>Weight Progress</h3>
                    <div className="chart-container">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        function KilojouleTracker() {
            const DAILY_LIMIT_DEFAULT = 6500;
            const [meals, setMeals] = useState([]);
            const [mealType, setMealType] = useState('Breakfast');
            const [kilojoules, setKilojoules] = useState('');
            const [calories, setCalories] = useState('');
            const [weightEntries, setWeightEntries] = useState([]);
            const [newWeight, setNewWeight] = useState('');
            const [showWeightSection, setShowWeightSection] = useState(false);
            const [showCalories, setShowCalories] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [dailyLimit, setDailyLimit] = useState(DAILY_LIMIT_DEFAULT);
            const [adaptiveMode, setAdaptiveMode] = useState(false);
            const [showCalculator, setShowCalculator] = useState(false);
            const [kjPer100g, setKjPer100g] = useState('');
            const [gramsEaten, setGramsEaten] = useState('');
            const [showFoodSearch, setShowFoodSearch] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searching, setSearching] = useState(false);

            useEffect(() => {
                loadMeals();
                loadWeightEntries();
                loadSettings();
            }, []);

            const loadMeals = () => {
                try {
                    const today = new Date();
                    const dateKey = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear().toString().slice(-2)}`;
                    const stored = localStorage.getItem(`meals:${dateKey}`);
                    if (stored) {
                        setMeals(JSON.parse(stored));
                    }
                } catch (error) {
                    console.log('No meals found');
                }
            };

            const saveMeals = (updatedMeals) => {
                try {
                    const today = new Date();
                    const dateKey = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear().toString().slice(-2)}`;
                    localStorage.setItem(`meals:${dateKey}`, JSON.stringify(updatedMeals));
                } catch (error) {
                    console.error('Error saving meals:', error);
                }
            };

            const loadWeightEntries = () => {
                try {
                    const stored = localStorage.getItem('weight-entries');
                    if (stored) {
                        setWeightEntries(JSON.parse(stored));
                    }
                } catch (error) {
                    console.log('No weight entries found');
                }
            };

            const saveWeightEntries = (entries) => {
                try {
                    localStorage.setItem('weight-entries', JSON.stringify(entries));
                } catch (error) {
                    console.error('Error saving weight entries:', error);
                }
            };

            const loadSettings = () => {
                try {
                    const stored = localStorage.getItem('settings');
                    if (stored) {
                        const settings = JSON.parse(stored);
                        setDailyLimit(settings.dailyLimit || DAILY_LIMIT_DEFAULT);
                        setAdaptiveMode(settings.adaptiveMode || false);
                    }
                } catch (error) {
                    console.log('No settings found');
                }
            };

            const saveSettings = (newLimit, newAdaptiveMode) => {
                try {
                    const settings = { 
                        dailyLimit: newLimit !== undefined ? newLimit : dailyLimit,
                        adaptiveMode: newAdaptiveMode !== undefined ? newAdaptiveMode : adaptiveMode
                    };
                    localStorage.setItem('settings', JSON.stringify(settings));
                    if (newLimit !== undefined) setDailyLimit(newLimit);
                    if (newAdaptiveMode !== undefined) setAdaptiveMode(newAdaptiveMode);
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            };

            const getAdaptiveDailyLimit = () => {
                if (!adaptiveMode) return dailyLimit;
                
                const today = new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
                const isWeekday = today >= 1 && today <= 4; // Monday to Thursday
                
                const weekdayReduction = Math.round(dailyLimit * 0.0769); // 7.69% reduction
                
                if (isWeekday) {
                    return dailyLimit - weekdayReduction;
                } else {
                    // Friday (5), Saturday (6), Sunday (0)
                    const totalSaved = weekdayReduction * 4; // Total from 4 weekdays
                    const weekendAddition = totalSaved / 3; // Split across 3 weekend days
                    const weekendLimit = dailyLimit + weekendAddition;
                    return Math.round(weekendLimit / 50) * 50; // Round to nearest 50
                }
            };

            const currentDailyLimit = getAdaptiveDailyLimit();

            const addWeightEntry = () => {
                if (!newWeight || isNaN(newWeight) || Number(newWeight) <= 0) {
                    alert('Please enter a valid weight');
                    return;
                }

                const today = new Date();
                const dateStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear().toString().slice(-2)}`;

                const entry = {
                    id: Date.now(),
                    weight: Number(newWeight),
                    date: dateStr,
                    displayDate: `${today.getDate()} ${['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][today.getMonth()]}`
                };

                const updatedEntries = [...weightEntries, entry].sort((a, b) => {
                    const [dayA, monthA, yearA] = a.date.split('/').map(Number);
                    const [dayB, monthB, yearB] = b.date.split('/').map(Number);
                    const dateA = new Date(2000 + yearA, monthA - 1, dayA);
                    const dateB = new Date(2000 + yearB, monthB - 1, dayB);
                    return dateA - dateB;
                });
                
                setWeightEntries(updatedEntries);
                saveWeightEntries(updatedEntries);
                setNewWeight('');
            };

            const deleteWeightEntry = (id) => {
                const updatedEntries = weightEntries.filter(entry => entry.id !== id);
                setWeightEntries(updatedEntries);
                saveWeightEntries(updatedEntries);
            };

            const totalKJ = meals.reduce((sum, meal) => sum + meal.kj, 0);
            const remaining = currentDailyLimit - totalKJ;

            const addMeal = () => {
                let kjValue = 0;
                
                if (calories && !isNaN(calories) && Number(calories) > 0) {
                    kjValue = Math.round(Number(calories) * 4.184);
                } else if (kilojoules && !isNaN(kilojoules) && Number(kilojoules) > 0) {
                    kjValue = Number(kilojoules);
                } else {
                    alert('Please enter either kilojoules or calories');
                    return;
                }

                const newMeal = {
                    id: Date.now(),
                    type: mealType,
                    kj: kjValue,
                    time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };

                const updatedMeals = [...meals, newMeal];
                setMeals(updatedMeals);
                saveMeals(updatedMeals);
                setKilojoules('');
                setCalories('');
            };

            const deleteMeal = (id) => {
                const updatedMeals = meals.filter(meal => meal.id !== id);
                setMeals(updatedMeals);
                saveMeals(updatedMeals);
            };

            const getMealEmoji = (type) => {
                const emojis = {
                    'Breakfast': 'üç≥',
                    'Lunch': 'üç±',
                    'Dinner': 'üçΩÔ∏è',
                    'Dessert': 'üç∞'
                };
                return emojis[type] || 'üç¥';
            };

            const weightLoss = weightEntries.length >= 2 
                ? weightEntries[0].weight - weightEntries[weightEntries.length - 1].weight 
                : 0;

            const calculatedKj = (kjPer100g && gramsEaten) 
                ? Math.round((Number(kjPer100g) / 100) * Number(gramsEaten))
                : 0;

            const searchFood = async () => {
                if (!searchQuery.trim()) return;
                
                setSearching(true);
                try {
                    const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(searchQuery)}&search_simple=1&action=process&json=1&page_size=5&fields=product_name,brands,nutriments`, {
                        method: 'GET',
                        headers: {
                            'User-Agent': 'KJTracker - Health App'
                        }
                    });
                    
                    if (!response.ok) throw new Error('API request failed');
                    
                    const data = await response.json();
                    
                    if (data.products && data.products.length > 0) {
                        const results = data.products.map(product => {
                            const kj = product.nutriments?.['energy-kj_100g'] || 
                                      (product.nutriments?.['energy-kcal_100g'] ? Math.round(product.nutriments['energy-kcal_100g'] * 4.184) : null) ||
                                      (product.nutriments?.energy_100g ? Math.round(product.nutriments.energy_100g / 1000 * 0.239) : null);
                            
                            return {
                                name: product.product_name || 'Unknown',
                                kj: kj,
                                calories: product.nutriments?.['energy-kcal_100g'] || null,
                                brands: product.brands || ''
                            };
                        }).filter(r => r.kj);
                        
                        setSearchResults(results);
                    } else {
                        setSearchResults([]);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    alert('Could not connect to food database. Please check your internet connection.');
                    setSearchResults([]);
                }
                setSearching(false);
            };

            return (
                <div className="container">
                    <div className="card tabs">
                        <button
                            onClick={() => {
                                setShowWeightSection(false);
                                setShowSettings(false);
                            }}
                            className={`tab ${!showWeightSection && !showSettings ? 'active' : ''}`}
                        >
                            üçΩÔ∏è Today
                        </button>
                        <button
                            onClick={() => {
                                setShowWeightSection(true);
                                setShowSettings(false);
                            }}
                            className={`tab ${showWeightSection && !showSettings ? 'active' : ''}`}
                        >
                            üìä Weight
                        </button>
                        <button
                            onClick={() => {
                                setShowWeightSection(false);
                                setShowSettings(true);
                            }}
                            className={`tab ${showSettings ? 'active' : ''}`}
                        >
                            ‚öôÔ∏è Settings
                        </button>
                    </div>

                    {showSettings ? (
                        <>
                            <div className="card">
                                <h3>Daily Limit</h3>
                                <label>Set your daily kilojoule limit</label>
                                <input
                                    type="number"
                                    value={dailyLimit}
                                    onChange={(e) => {
                                        const value = Number(e.target.value);
                                        if (value > 0) {
                                            saveSettings(value, undefined);
                                        }
                                    }}
                                    placeholder="Enter daily kJ limit"
                                />
                                <div style={{marginTop: '0.75rem', color: '#6b7280', fontSize: '0.875rem', textAlign: 'center'}}>
                                    = {Math.round(dailyLimit / 4.184).toLocaleString()} calories per day
                                </div>
                                
                                <div className="checkbox-container">
                                    <input
                                        type="checkbox"
                                        id="adaptive-mode"
                                        checked={adaptiveMode}
                                        onChange={(e) => saveSettings(undefined, e.target.checked)}
                                    />
                                    <label htmlFor="adaptive-mode" className="checkbox-label">
                                        Adaptive Mode - Higher kJ Limit on Weekends
                                    </label>
                                </div>
                                
                                {adaptiveMode && (
                                    <div style={{marginTop: '0.75rem', padding: '0.75rem', background: 'linear-gradient(145deg, #d8e7f7, #d3e2f4)', borderRadius: '0.75rem', fontSize: '0.875rem', color: '#4b5563'}}>
                                        <div style={{fontWeight: '600', marginBottom: '0.5rem'}}>Adaptive Limits:</div>
                                        <div>Mon-Thu: {(dailyLimit - Math.round(dailyLimit * 0.0769)).toLocaleString()} kJ ({Math.round((dailyLimit - Math.round(dailyLimit * 0.0769)) / 4.184).toLocaleString()} cal)</div>
                                        <div>Fri-Sun: {Math.round((dailyLimit + (Math.round(dailyLimit * 0.0769) * 4 / 3)) / 50) * 50} kJ ({Math.round(Math.round((dailyLimit + (Math.round(dailyLimit * 0.0769) * 4 / 3)) / 50) * 50 / 4.184).toLocaleString()} cal)</div>
                                    </div>
                                )}
                            </div>
                        </>
                    ) : !showWeightSection ? (
                        <>
                            <div className="card remaining-display">
                                <div className="remaining-label">
                                    Remaining Today
                                    <button onClick={() => setShowCalories(!showCalories)} className="unit-toggle">
                                        {showCalories ? 'kJ' : 'cal'}
                                    </button>
                                </div>
                                <div className={`remaining-value ${remaining >= 0 ? 'positive' : 'negative'}`}>
                                    {showCalories ? Math.round(remaining / 4.184).toLocaleString() : remaining.toLocaleString()}
                                </div>
                                <div className="remaining-unit">{showCalories ? 'calories' : 'kJ'}</div>
                                <div className="progress-bar">
                                    <div 
                                        className={`progress-fill ${totalKJ > currentDailyLimit ? 'over' : 'good'}`}
                                        style={{ width: `${Math.min((totalKJ / currentDailyLimit) * 100, 100)}%` }}
                                    />
                                </div>
                                <div className="progress-text">
                                    {showCalories ? `${Math.round(totalKJ / 4.184).toLocaleString()} / ${Math.round(currentDailyLimit / 4.184).toLocaleString()} calories` : `${totalKJ.toLocaleString()} / ${currentDailyLimit.toLocaleString()} kJ`}
                                </div>
                            </div>

                            <div className="card">
                                <div className="header-with-icon">
                                    <h3 style={{margin: 0}}>Log Meal</h3>
                                    <div style={{display: 'flex', gap: '0.5rem'}}>
                                        <button 
                                            onClick={() => {
                                                setShowFoodSearch(!showFoodSearch);
                                                if (showCalculator) setShowCalculator(false);
                                            }} 
                                            className="calc-icon-btn" 
                                            title="Food Search"
                                        >
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <circle cx="11" cy="11" r="8"></circle>
                                                <path d="m21 21-4.35-4.35"></path>
                                            </svg>
                                        </button>
                                        <button 
                                            onClick={() => {
                                                setShowCalculator(!showCalculator);
                                                if (showFoodSearch) setShowFoodSearch(false);
                                            }} 
                                            className="calc-icon-btn" 
                                            title="kJ Calculator"
                                        >
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                                                <line x1="8" y1="6" x2="16" y2="6"></line>
                                                <rect x="7.5" y="10.5" width="1" height="1"></rect>
                                                <rect x="11.5" y="10.5" width="1" height="1"></rect>
                                                <rect x="15.5" y="10.5" width="1" height="1"></rect>
                                                <rect x="7.5" y="14" width="1" height="1"></rect>
                                                <rect x="11.5" y="14" width="1" height="1"></rect>
                                                <rect x="15.5" y="14" width="1" height="1"></rect>
                                                <rect x="7.5" y="17.5" width="1" height="1"></rect>
                                                <rect x="11.5" y="17.5" width="1" height="1"></rect>
                                                <rect x="15.5" y="17.5" width="1" height="1"></rect>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                {showFoodSearch && (
                                    <div className="calculator-panel">
                                        <div className="calculator-title">üîç Food Search</div>
                                        
                                        <label style={{fontSize: '0.75rem'}}>Search for a food</label>
                                        <input
                                            type="text"
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && searchFood()}
                                            placeholder="e.g., tomato, apple, bread"
                                            style={{marginBottom: '0.5rem'}}
                                        />
                                        
                                        <button 
                                            onClick={searchFood}
                                            className="btn-primary"
                                            style={{marginTop: '0.5rem'}}
                                            disabled={searching}
                                        >
                                            {searching ? 'Searching...' : 'Search'}
                                        </button>
                                        
                                        {searchResults.length > 0 && (
                                            <div style={{marginTop: '0.75rem'}}>
                                                <div style={{fontSize: '0.75rem', fontWeight: 600, color: '#4b5563', marginBottom: '0.5rem'}}>
                                                    Results (per 100g):
                                                </div>
                                                {searchResults.map((result, index) => (
                                                    <div 
                                                        key={index} 
                                                        className="search-result-item"
                                                        onClick={() => {
                                                            setKjPer100g(result.kj || Math.round(result.calories * 4.184));
                                                            setShowFoodSearch(false);
                                                            setShowCalculator(true);
                                                        }}
                                                    >
                                                        <div className="search-result-name">{result.name}</div>
                                                        {result.brands && <div className="search-result-brand">{result.brands}</div>}
                                                        <div className="search-result-kj">
                                                            {result.kj ? `${result.kj} kJ` : `${result.calories} cal (${Math.round(result.calories * 4.184)} kJ)`} per 100g
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {!searching && searchResults.length === 0 && searchQuery && (
                                            <div style={{marginTop: '0.75rem', textAlign: 'center', color: '#6b7280', fontSize: '0.875rem'}}>
                                                No results found. Try a different search term.
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {showCalculator && (
                                    <div className="calculator-panel">
                                        <div className="calculator-title">üßÆ kJ Calculator</div>
                                        
                                        <label style={{fontSize: '0.75rem'}}>Amount of kJ per 100g?</label>
                                        <input
                                            type="number"
                                            value={kjPer100g}
                                            onChange={(e) => setKjPer100g(e.target.value)}
                                            placeholder="Enter kJ per 100g"
                                            style={{marginBottom: '0.5rem'}}
                                        />
                                        
                                        <label style={{fontSize: '0.75rem'}}>How many grams did you eat?</label>
                                        <input
                                            type="number"
                                            value={gramsEaten}
                                            onChange={(e) => setGramsEaten(e.target.value)}
                                            placeholder="Enter grams"
                                        />
                                        
                                        {calculatedKj > 0 && (
                                            <div style={{marginTop: '0.75rem', textAlign: 'center', padding: '0.75rem', background: 'linear-gradient(145deg, #f2f8ff, #edf5ff)', borderRadius: '0.5rem'}}>
                                                <div style={{fontSize: '0.75rem', color: '#6b7280', fontWeight: 600}}>Result</div>
                                                <div style={{fontSize: '1.5rem', fontWeight: 700, color: '#6987fe'}}>{calculatedKj.toLocaleString()} kJ</div>
                                                <div style={{fontSize: '0.75rem', color: '#6b7280'}}>
                                                    ({Math.round(calculatedKj / 4.184).toLocaleString()} calories)
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <label>Meal Type</label>
                                <div className="button-grid">
                                    {['Breakfast', 'Lunch', 'Dinner', 'Dessert'].map(type => (
                                        <button
                                            key={type}
                                            onClick={() => setMealType(type)}
                                            className={`meal-btn ${mealType === type ? 'active' : ''}`}
                                        >
                                            {getMealEmoji(type)} {type}
                                        </button>
                                    ))}
                                </div>
                                <label>Kilojoules</label>
                                <input
                                    type="number"
                                    value={kilojoules}
                                    onChange={(e) => {
                                        setKilojoules(e.target.value);
                                        if (e.target.value) {
                                            setCalories('');
                                        }
                                    }}
                                    placeholder="Enter kJ"
                                />
                                <label style={{marginTop: '0.5rem'}}>Or Calories</label>
                                <input
                                    type="number"
                                    value={calories}
                                    onChange={(e) => {
                                        setCalories(e.target.value);
                                        if (e.target.value) {
                                            setKilojoules('');
                                        }
                                    }}
                                    placeholder="Enter calories"
                                />
                                <button onClick={addMeal} className="btn-primary">
                                    <Plus /> Add Meal
                                </button>
                            </div>

                            {meals.length > 0 && (
                                <div className="card">
                                    <h3>Today's Meals</h3>
                                    {meals.map(meal => (
                                        <div key={meal.id} className="meal-item">
                                            <div className="meal-info">
                                                <span className="meal-emoji">{getMealEmoji(meal.type)}</span>
                                                <div>
                                                    <div className="meal-name">{meal.type}</div>
                                                    <div className="meal-time">{meal.time}</div>
                                                </div>
                                            </div>
                                            <div style={{display: 'flex', alignItems: 'center'}}>
                                                <span className="meal-kj">{meal.kj} kJ</span>
                                                <button onClick={() => deleteMeal(meal.id)} className="btn-delete">
                                                    <Trash2 />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    ) : (
                        <>
                            {weightEntries.length > 0 && (
                                <div className="card">
                                    <div className="stats-grid">
                                        <div className="stat-box">
                                            <div className="stat-label">Current Weight</div>
                                            <div className="stat-value">
                                                {weightEntries[weightEntries.length - 1].weight}
                                                <span className="stat-unit">kg</span>
                                            </div>
                                        </div>
                                        <div className="stat-box">
                                            <div className="stat-label">Total Loss</div>
                                            <div className={`stat-value ${weightLoss > 0 ? 'loss' : ''}`}>
                                                {weightLoss > 0 ? '-' : ''}{Math.abs(weightLoss).toFixed(1)}
                                                <span className="stat-unit">kg</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <WeightChart data={weightEntries} />

                            <div className="card">
                                <h3>Log Weight</h3>
                                <label>Weight (kg)</label>
                                <input
                                    type="number"
                                    step="0.1"
                                    value={newWeight}
                                    onChange={(e) => setNewWeight(e.target.value)}
                                    placeholder="Enter weight in kg"
                                />
                                <button onClick={addWeightEntry} className="btn-primary">
                                    üìä Add Weight
                                </button>
                            </div>

                            {weightEntries.length > 0 && (
                                <div className="card">
                                    <h3>Weight History</h3>
                                    {[...weightEntries].reverse().map(entry => (
                                        <div key={entry.id} className="weight-item">
                                            <div>
                                                <div className="meal-name">{entry.weight} kg</div>
                                                <div className="meal-time">{entry.date}</div>
                                            </div>
                                            <button onClick={() => deleteWeightEntry(entry.id)} className="btn-delete">
                                                <Trash2 />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<KilojouleTracker />, document.getElementById('root'));
    </script>
</body>
</html>